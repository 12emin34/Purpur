From 1debe995bd2c920910bbff750353714006b2a131 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Fri, 18 Oct 2019 22:50:12 -0500
Subject: [PATCH] Add more llama API

---
 .../net/minecraft/server/EntityLlama.java     | 20 ++++++---
 .../server/PathfinderGoalLlamaFollow.java     |  4 +-
 .../bukkit/craftbukkit/entity/CraftLlama.java | 44 +++++++++++++++++++
 3 files changed, 62 insertions(+), 6 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityLlama.java b/src/main/java/net/minecraft/server/EntityLlama.java
index 72372497d9..a8cf42fd35 100644
--- a/src/main/java/net/minecraft/server/EntityLlama.java
+++ b/src/main/java/net/minecraft/server/EntityLlama.java
@@ -12,7 +12,8 @@ public class EntityLlama extends EntityHorseChestedAbstract implements IRangedEn
     @Nullable
     private EntityLlama bM;
     @Nullable
-    private EntityLlama bN;
+    private EntityLlama bN; @Nullable public EntityLlama getCaravanTail() { return bN; } // Purpur - OBFHELPER
+    public boolean shouldJoinCaravan = true; // Purpur
 
     public EntityLlama(EntityTypes<? extends EntityLlama> entitytypes, World world) {
         super(entitytypes, world);
@@ -63,7 +64,7 @@ public class EntityLlama extends EntityHorseChestedAbstract implements IRangedEn
         if (!this.inventoryChest.getItem(1).isEmpty()) {
             nbttagcompound.set("DecorItem", this.inventoryChest.getItem(1).save(new NBTTagCompound()));
         }
-
+        nbttagcompound.setBoolean("Purpur.ShouldJoinCaravan", shouldJoinCaravan); // Purpur
     }
 
     @Override
@@ -74,7 +75,11 @@ public class EntityLlama extends EntityHorseChestedAbstract implements IRangedEn
         if (nbttagcompound.hasKeyOfType("DecorItem", 10)) {
             this.inventoryChest.setItem(1, ItemStack.a(nbttagcompound.getCompound("DecorItem")));
         }
-
+        // Purpur start
+        if (nbttagcompound.hasKey("Purpur.ShouldJoinCaravan")) {
+            nbttagcompound.setBoolean("Purpur.ShouldJoinCaravan", shouldJoinCaravan);
+        }
+        // Purpur end
         this.en();
     }
 
@@ -409,29 +414,34 @@ public class EntityLlama extends EntityHorseChestedAbstract implements IRangedEn
         }
     }
 
+    public void leaveCaravan() { eG(); } // Purpur - OBFHELPER
     public void eG() {
         if (this.bM != null) {
+            new net.pl3x.purpur.event.entity.LlamaLeaveCaravanEvent((org.bukkit.entity.Llama) getBukkitEntity()).callEvent(); // Purpur
             this.bM.bN = null;
         }
 
         this.bM = null;
     }
 
+    public void joinCaravan(EntityLlama entitiyllama) { a(entitiyllama); } // Purpur - OBFHELPER
     public void a(EntityLlama entityllama) {
+        if (!shouldJoinCaravan || !new net.pl3x.purpur.event.entity.LlamaJoinCaravanEvent((org.bukkit.entity.Llama) getBukkitEntity(), (org.bukkit.entity.Llama) entityllama.getBukkitEntity()).callEvent()) return; // Purpur
         this.bM = entityllama;
         this.bM.bN = this;
     }
 
+    public boolean hasCaravanTail() { return eH(); } // Purpur - OBFHELPER
     public boolean eH() {
         return this.bN != null;
     }
 
+    public boolean inCaravan() { return eI(); } // Purpur - OBFHELPER
     public boolean eI() {
         return this.bM != null;
     }
 
-    @Nullable
-    public EntityLlama eJ() {
+    public EntityLlama getCaravanHead() { return eJ(); } @Nullable public EntityLlama eJ() { // Purpur - OBFHELPER
         return this.bM;
     }
 
diff --git a/src/main/java/net/minecraft/server/PathfinderGoalLlamaFollow.java b/src/main/java/net/minecraft/server/PathfinderGoalLlamaFollow.java
index a46a985a65..9cc0d2e956 100644
--- a/src/main/java/net/minecraft/server/PathfinderGoalLlamaFollow.java
+++ b/src/main/java/net/minecraft/server/PathfinderGoalLlamaFollow.java
@@ -6,7 +6,7 @@ import java.util.List;
 
 public class PathfinderGoalLlamaFollow extends PathfinderGoal {
 
-    public final EntityLlama a;
+    public final EntityLlama a; public EntityLlama getLlama() { return a; } // Purpur
     private double b;
     private int c;
 
@@ -18,6 +18,7 @@ public class PathfinderGoalLlamaFollow extends PathfinderGoal {
 
     @Override
     public boolean a() {
+        if (!getLlama().shouldJoinCaravan) return false; // Purpur
         if (!this.a.isLeashed() && !this.a.eI()) {
             List<Entity> list = this.a.world.getEntities(this.a, this.a.getBoundingBox().grow(9.0D, 4.0D, 9.0D), (entity) -> {
                 EntityTypes<?> entitytypes = entity.getEntityType();
@@ -77,6 +78,7 @@ public class PathfinderGoalLlamaFollow extends PathfinderGoal {
 
     @Override
     public boolean b() {
+        if (!getLlama().shouldJoinCaravan) return false; // Purpur
         if (this.a.eI() && this.a.eJ().isAlive() && this.a(this.a, 0)) {
             double d0 = this.a.h((Entity) this.a.eJ());
 
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftLlama.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftLlama.java
index 3f94c5a920..a027634801 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftLlama.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftLlama.java
@@ -65,4 +65,48 @@ public class CraftLlama extends CraftChestedHorse implements Llama, CraftRangedE
     public EntityType getType() {
         return EntityType.LLAMA;
     }
+
+    // Purpur start
+    @Override
+    public boolean shouldJoinCaravan() {
+        return getHandle().shouldJoinCaravan;
+    }
+
+    @Override
+    public void setShouldJoinCaravan(boolean shouldJoinCaravan) {
+        getHandle().shouldJoinCaravan = shouldJoinCaravan;
+    }
+
+    @Override
+    public boolean inCaravan() {
+        return getHandle().inCaravan();
+    }
+
+    @Override
+    public void joinCaravan(Llama llama) {
+        if (llama != null) {
+            getHandle().joinCaravan(((CraftLlama) llama).getHandle());
+        }
+    }
+
+    @Override
+    public void leaveCaravan() {
+        getHandle().leaveCaravan();
+    }
+
+    @Override
+    public boolean hasCaravanTail() {
+        return getHandle().hasCaravanTail();
+    }
+
+    @Override
+    public Llama getCaravanHead() {
+        return getHandle().getCaravanHead() == null ? null : (Llama) getHandle().getCaravanHead().getBukkitEntity();
+    }
+
+    @Override
+    public Llama getCaravanTail() {
+        return getHandle().getCaravanTail() == null ? null : (Llama) getHandle().getCaravanTail().getBukkitEntity();
+    }
+    // Purpur end
 }
-- 
2.24.0.rc1

