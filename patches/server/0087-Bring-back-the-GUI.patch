From c9f532624c52ae48b4af5280b2dc57298f529e18 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <Blake.Galbreath@GMail.com>
Date: Thu, 16 Jan 2020 14:59:16 -0600
Subject: [PATCH] Bring back the GUI

---
 .../net/minecraft/server/MinecraftServer.java     |  3 ++-
 src/main/java/org/bukkit/craftbukkit/Main.java    |  1 +
 src/main/resources/log4j2.xml                     | 15 ++++++++++++++-
 3 files changed, 17 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index ab00ed8394..fd4fdaaac1 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -1367,12 +1367,13 @@ public abstract class MinecraftServer extends IAsyncTaskHandlerReentrant<TickTas
             dedicatedserver.setForceUpgrade(optionset.has(optionspec4));
             dedicatedserver.setEraseCache(optionset.has(optionspec5));
             dedicatedserver.c((String) optionset.valueOf(optionspec11));
-            boolean flag = !optionset.has(optionspec) && !optionset.valuesOf(nonoptionargumentspec).contains("nogui");
+            */ boolean flag = !optionset.has("nogui") && !optionset.nonOptionArguments().contains("nogui"); // Purpur
 
             if (flag && !GraphicsEnvironment.isHeadless()) {
                 dedicatedserver.bb();
             }
 
+            /* // Purpur
             dedicatedserver.startServerThread();
             Thread thread = new Thread("Server Shutdown Thread") {
                 public void run() {
diff --git a/src/main/java/org/bukkit/craftbukkit/Main.java b/src/main/java/org/bukkit/craftbukkit/Main.java
index c9937fb0d6..3423535d1e 100644
--- a/src/main/java/org/bukkit/craftbukkit/Main.java
+++ b/src/main/java/org/bukkit/craftbukkit/Main.java
@@ -143,6 +143,7 @@ public class Main {
                         .ofType(File.class)
                         .defaultsTo(new File("purpur.yml"))
                         .describedAs("Yml file");
+                accepts("nogui", "Disables the graphical window");
                 // Purpur end
 
                 // Paper start
diff --git a/src/main/resources/log4j2.xml b/src/main/resources/log4j2.xml
index 6711e6dff9..65ba664922 100644
--- a/src/main/resources/log4j2.xml
+++ b/src/main/resources/log4j2.xml
@@ -1,5 +1,5 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<Configuration status="WARN">
+<Configuration status="WARN" packages="com.mojang.util">
     <Appenders>
         <TerminalConsole name="TerminalConsole">
             <PatternLayout>
@@ -11,6 +11,18 @@
                 </LoggerNamePatternSelector>
             </PatternLayout>
         </TerminalConsole>
+        <!-- Purpur start -->
+        <Queue name="ServerGuiConsole">
+            <PatternLayout>
+                <LoggerNamePatternSelector defaultPattern="%highlightError{[%d{HH:mm:ss} %level]: [%logger] %minecraftFormatting{%msg}%n%xEx}">
+                    <!-- Log root, Minecraft, Mojang and Bukkit loggers without prefix -->
+                    <!-- Disable prefix for various plugins that bypass the plugin logger -->
+                    <PatternMatch key=",net.minecraft.,Minecraft,com.mojang.,com.sk89q.,ru.tehkode.,Minecraft.AWE"
+                                  pattern="%highlightError{[%d{HH:mm:ss} %level]: %minecraftFormatting{%msg}%n%xEx}" />
+                </LoggerNamePatternSelector>
+            </PatternLayout>
+        </Queue>
+        <!-- Purpur end -->
         <RollingRandomAccessFile name="File" fileName="logs/latest.log" filePattern="logs/%d{yyyy-MM-dd}-%i.log.gz">
             <PatternLayout>
                 <LoggerNamePatternSelector defaultPattern="[%d{HH:mm:ss}] [%t/%level]: [%logger] %minecraftFormatting{%msg}{strip}%n">
@@ -33,6 +45,7 @@
                 <MarkerFilter marker="NETWORK_PACKETS" onMatch="DENY" onMismatch="NEUTRAL" />
             </filters>
             <AppenderRef ref="File"/>
+            <AppenderRef ref="ServerGuiConsole"/> <!-- Purpur -->
             <AppenderRef ref="TerminalConsole" level="info"/>
         </Root>
     </Loggers>
-- 
2.24.0

