From 9b22151ca279174b771b39bf13bea6f2422c9700 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Sun, 5 May 2019 12:58:45 -0500
Subject: [PATCH] Implement LivingEntity safeFallDistance

---
 .../java/net/minecraft/server/EntityGiantZombie.java |  3 +++
 .../net/minecraft/server/EntityHorseAbstract.java    |  2 +-
 src/main/java/net/minecraft/server/EntityLiving.java |  3 ++-
 src/main/java/net/minecraft/server/EntityLlama.java  |  2 +-
 .../bukkit/craftbukkit/entity/CraftLivingEntity.java | 12 ++++++++++++
 5 files changed, 19 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityGiantZombie.java b/src/main/java/net/minecraft/server/EntityGiantZombie.java
index dd827aea..053a880c 100644
--- a/src/main/java/net/minecraft/server/EntityGiantZombie.java
+++ b/src/main/java/net/minecraft/server/EntityGiantZombie.java
@@ -7,6 +7,9 @@ public class EntityGiantZombie extends EntityMonster {
     public EntityGiantZombie(World world) {
         super(EntityTypes.GIANT, world);
         this.setSize(this.width * 6.0F, this.length * 6.0F);
+        // Purpur start
+        this.safeFallDistance = 10.0F;
+        // Purpur end
     }
 
     public float getHeadHeight() {
diff --git a/src/main/java/net/minecraft/server/EntityHorseAbstract.java b/src/main/java/net/minecraft/server/EntityHorseAbstract.java
index 95327763..e211b95c 100644
--- a/src/main/java/net/minecraft/server/EntityHorseAbstract.java
+++ b/src/main/java/net/minecraft/server/EntityHorseAbstract.java
@@ -181,7 +181,7 @@ public abstract class EntityHorseAbstract extends EntityAnimal implements IInven
             this.a(SoundEffects.ENTITY_HORSE_LAND, 0.4F, 1.0F);
         }
 
-        int i = MathHelper.f((f * 0.5F - 3.0F) * f1);
+        int i = MathHelper.f((f * 0.5F - this.safeFallDistance) * f1); // Purpur
 
         if (i > 0) {
             this.damageEntity(DamageSource.FALL, (float) i);
diff --git a/src/main/java/net/minecraft/server/EntityLiving.java b/src/main/java/net/minecraft/server/EntityLiving.java
index 4d5459d2..13a3bd02 100644
--- a/src/main/java/net/minecraft/server/EntityLiving.java
+++ b/src/main/java/net/minecraft/server/EntityLiving.java
@@ -122,6 +122,7 @@ public abstract class EntityLiving extends Entity {
     // CraftBukkit start
     public int expToDrop;
     public int maxAirTicks = 300;
+    public float safeFallDistance = 3.0F;
     boolean forceDrops;
     ArrayList<org.bukkit.inventory.ItemStack> drops = new ArrayList<org.bukkit.inventory.ItemStack>();
     public org.bukkit.craftbukkit.attribute.CraftAttributeMap craftAttributes;
@@ -1368,7 +1369,7 @@ public abstract class EntityLiving extends Entity {
         super.c(f, f1);
         MobEffect mobeffect = this.getEffect(MobEffects.JUMP);
         float f2 = mobeffect == null ? 0.0F : (float) (mobeffect.getAmplifier() + 1);
-        int i = MathHelper.f((f - 3.0F - f2) * f1);
+        int i = MathHelper.f((f - this.safeFallDistance - f2) * f1); // Purpur
 
         if (i > 0) {
             // CraftBukkit start
diff --git a/src/main/java/net/minecraft/server/EntityLlama.java b/src/main/java/net/minecraft/server/EntityLlama.java
index 82a32c61..5e752b0c 100644
--- a/src/main/java/net/minecraft/server/EntityLlama.java
+++ b/src/main/java/net/minecraft/server/EntityLlama.java
@@ -318,7 +318,7 @@ public class EntityLlama extends EntityHorseChestedAbstract implements IRangedEn
     }
 
     public void c(float f, float f1) {
-        int i = MathHelper.f((f * 0.5F - 3.0F) * f1);
+        int i = MathHelper.f((f * 0.5F - this.safeFallDistance) * f1); // Purpur
 
         if (i > 0) {
             if (f >= 6.0F) {
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
index d6a4bc64..89a49f03 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftLivingEntity.java
@@ -633,4 +633,16 @@ public class CraftLivingEntity extends CraftEntity implements LivingEntity {
         return getHandle().isHandRaised();
     }
     // Paper end
+
+    // Purpur start
+    @Override
+    public float getSafeFallDistance() {
+        return getHandle().safeFallDistance;
+    }
+
+    @Override
+    public void setSafeFallDistance(float safeFallDistance) {
+        getHandle().safeFallDistance = safeFallDistance;
+    }
+    // Purpur end
 }
-- 
2.20.1

