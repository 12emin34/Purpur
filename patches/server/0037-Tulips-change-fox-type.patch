From 803c0cf62b101817c67792d4794ee4120070f1cf Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Sat, 13 Jul 2019 15:56:22 -0500
Subject: [PATCH] Tulips change fox type

---
 .../java/net/minecraft/server/EntityFox.java  | 27 +++++++++++++++++++
 src/main/java/net/minecraft/server/Items.java |  4 +--
 .../net/pl3x/purpur/PurpurWorldConfig.java    |  5 ++++
 3 files changed, 34 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityFox.java b/src/main/java/net/minecraft/server/EntityFox.java
index 738e6cb8f7..744640450a 100644
--- a/src/main/java/net/minecraft/server/EntityFox.java
+++ b/src/main/java/net/minecraft/server/EntityFox.java
@@ -228,6 +228,11 @@ public class EntityFox extends EntityAnimal {
     }
 
     private void initializePathFinderGoals() {
+        // Purpur start - do not add duplicate goals
+        this.targetSelector.a(this.bE);
+        this.targetSelector.a(this.bF);
+        this.targetSelector.a(this.bG);
+        // Purpur end
         if (this.getFoxType() == EntityFox.Type.RED) {
             this.targetSelector.a(4, this.bE);
             this.targetSelector.a(4, this.bF);
@@ -260,6 +265,7 @@ public class EntityFox extends EntityAnimal {
 
     public void setFoxType(EntityFox.Type entityfox_type) {
         this.datawatcher.set(EntityFox.bw, entityfox_type.c());
+        initializePathFinderGoals(); // Purpur - fix API bug not updating pathfinders on type change
     }
 
     private List<UUID> eE() {
@@ -605,6 +611,27 @@ public class EntityFox extends EntityAnimal {
         return getRider() == null ? super.dp() : 0.5F;
     }
 
+    @Override
+    public boolean a(EntityHuman entityhuman, EnumHand enumhand) {
+        if (world.purpurConfig.foxTypeChangesWithTulips) {
+            ItemStack itemstack = entityhuman.b(enumhand);
+            if (getFoxType() == Type.RED && itemstack.getItem() == Items.WHITE_TULIP) {
+                setFoxType(Type.SNOW);
+                if (!entityhuman.abilities.canInstantlyBuild) {
+                    itemstack.subtract(1);
+                }
+                return true;
+            } else if (getFoxType() == Type.SNOW && itemstack.getItem() == Items.ORANGE_TULIP) {
+                setFoxType(Type.RED);
+                if (!entityhuman.abilities.canInstantlyBuild) {
+                    itemstack.subtract(1);
+                }
+                return true;
+            }
+        }
+        return super.a(entityhuman, enumhand);
+    }
+
     @Override
     public void onMount(EntityHuman entityhuman) {
         super.onMount(entityhuman);
diff --git a/src/main/java/net/minecraft/server/Items.java b/src/main/java/net/minecraft/server/Items.java
index 282fbca4fc..b261da87b7 100644
--- a/src/main/java/net/minecraft/server/Items.java
+++ b/src/main/java/net/minecraft/server/Items.java
@@ -106,8 +106,8 @@ public class Items {
     public static final Item aX = a(Blocks.ALLIUM, CreativeModeTab.c);
     public static final Item aY = a(Blocks.AZURE_BLUET, CreativeModeTab.c);
     public static final Item aZ = a(Blocks.RED_TULIP, CreativeModeTab.c);
-    public static final Item ba = a(Blocks.ORANGE_TULIP, CreativeModeTab.c);
-    public static final Item bb = a(Blocks.WHITE_TULIP, CreativeModeTab.c);
+    public static final Item ba = a(Blocks.ORANGE_TULIP, CreativeModeTab.c); public static final Item ORANGE_TULIP = ba; // Purpur - OBFHELPER
+    public static final Item bb = a(Blocks.WHITE_TULIP, CreativeModeTab.c); public static final Item WHITE_TULIP = bb; // Purpur - OBFHELPER
     public static final Item bc = a(Blocks.PINK_TULIP, CreativeModeTab.c);
     public static final Item bd = a(Blocks.OXEYE_DAISY, CreativeModeTab.c);
     public static final Item be = a(Blocks.CORNFLOWER, CreativeModeTab.c);
diff --git a/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java b/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java
index 81ece70d38..e5ea54a206 100644
--- a/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java
+++ b/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java
@@ -121,6 +121,11 @@ public class PurpurWorldConfig {
         enderDragonAlwaysDropsEggBlock = getBoolean("mobs.ender-dragon.always-drop-egg-block", enderDragonAlwaysDropsEggBlock);
     }
 
+    public boolean foxTypeChangesWithTulips = true;
+    private void foxSettings() {
+        foxTypeChangesWithTulips = getBoolean("mobs.fox.tulips-change-type", foxTypeChangesWithTulips);
+    }
+
     public boolean pigmenDontTargetUnlessHit = false;
     private void pigmenSettings() {
         pigmenDontTargetUnlessHit = getBoolean("mobs.pigmen.dont-target-unless-hit", pigmenDontTargetUnlessHit);
-- 
2.24.0

