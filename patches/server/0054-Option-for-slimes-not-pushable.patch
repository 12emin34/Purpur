From c5da017d13973de5d642a4b972296dbcdcf4ce59 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Fri, 23 Aug 2019 21:56:31 -0500
Subject: [PATCH] Option for slimes not pushable

---
 src/main/java/net/minecraft/server/BlockPiston.java | 12 ++++++++++++
 src/main/java/net/minecraft/server/BlockSlime.java  |  7 +++++++
 src/main/java/net/pl3x/purpur/PurpurConfig.java     | 13 +++++++++++++
 3 files changed, 32 insertions(+)

diff --git a/src/main/java/net/minecraft/server/BlockPiston.java b/src/main/java/net/minecraft/server/BlockPiston.java
index b29525c40d..3a47df79f3 100644
--- a/src/main/java/net/minecraft/server/BlockPiston.java
+++ b/src/main/java/net/minecraft/server/BlockPiston.java
@@ -10,6 +10,8 @@ import java.util.Map.Entry;
 // CraftBukkit start
 import com.google.common.collect.ImmutableList;
 import java.util.AbstractList;
+
+import org.bukkit.Material;
 import org.bukkit.craftbukkit.block.CraftBlock;
 import org.bukkit.event.block.BlockPistonRetractEvent;
 import org.bukkit.event.block.BlockPistonExtendEvent;
@@ -332,6 +334,16 @@ public class BlockPiston extends BlockDirectional {
             } else {
                 event = new BlockPistonRetractEvent(bblock, blocks, CraftBlock.notchToBlockFace(enumdirection1));
             }
+            // Purpur start
+            if (net.pl3x.purpur.PurpurConfig.slimeBlocksNotPushable) {
+                for (org.bukkit.block.Block block : blocks) {
+                    if (block.getType() == Material.SLIME_BLOCK) {
+                        event.setCancelled(true);
+                        break;
+                    }
+                }
+            }
+            // Purpur end
             world.getServer().getPluginManager().callEvent(event);
 
             if (event.isCancelled()) {
diff --git a/src/main/java/net/minecraft/server/BlockSlime.java b/src/main/java/net/minecraft/server/BlockSlime.java
index 01f32659d9..52ab86f0b1 100644
--- a/src/main/java/net/minecraft/server/BlockSlime.java
+++ b/src/main/java/net/minecraft/server/BlockSlime.java
@@ -49,4 +49,11 @@ public class BlockSlime extends BlockHalfTransparent {
 
         super.stepOn(world, blockposition, entity);
     }
+
+    // Purpur start
+    @Override
+    public EnumPistonReaction getPushReaction(IBlockData iblockdata) {
+        return net.pl3x.purpur.PurpurConfig.slimeBlocksNotPushable ? EnumPistonReaction.BLOCK : super.getPushReaction(iblockdata);
+    }
+    // Purpur end
 }
diff --git a/src/main/java/net/pl3x/purpur/PurpurConfig.java b/src/main/java/net/pl3x/purpur/PurpurConfig.java
index e6a8f9fb84..94ca1e0bcb 100644
--- a/src/main/java/net/pl3x/purpur/PurpurConfig.java
+++ b/src/main/java/net/pl3x/purpur/PurpurConfig.java
@@ -278,6 +278,19 @@ public class PurpurConfig {
         InventoryType.BARREL.setDefaultSize(packedBarrels ? 54 : 27);
     }
 
+    public static boolean slimeBlocksNotPushable = false;
+    private static void slimeBlocksNotPushable() {
+        if (version < 2) {
+            if (config.isSet("slimes-not-pushable")) {
+                slimeBlocksNotPushable = config.getBoolean("slimes-not-pushable", slimeBlocksNotPushable);
+            }
+            if (config.isSet("settings.slimes-not-pushable")) {
+                slimeBlocksNotPushable = config.getBoolean("settings.slimes-not-pushable", slimeBlocksNotPushable);
+            }
+        }
+        slimeBlocksNotPushable = getBoolean("settings.slime-blocks-not-pushable", slimeBlocksNotPushable);
+    }
+
     public static boolean ridableBat = true;
     public static boolean ridableBlaze = true;
     public static boolean ridableCat = true;
-- 
2.24.0.rc1

