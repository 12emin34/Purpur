From 0362adeb5dfa1f4f32b3781f4d4165df371ead53 Mon Sep 17 00:00:00 2001
From: William Blake Galbreath <blake.galbreath@gmail.com>
Date: Thu, 6 Jun 2019 23:23:52 -0500
Subject: [PATCH] Block and Fluid Tick Events

---
 .../java/net/minecraft/server/WorldServer.java |  6 ++++--
 .../net/pl3x/purpur/PurpurWorldConfig.java     |  7 +++++++
 .../org/bukkit/craftbukkit/CraftWorld.java     | 18 ++++++++++++++++++
 3 files changed, 29 insertions(+), 2 deletions(-)

diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 135ec94c6..a07785941 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -446,13 +446,13 @@ public class WorldServer extends World {
                         gameprofilerfiller.enter("randomTick");
                         IBlockData iblockdata = chunksection.getType(blockposition2.getX() - j, blockposition2.getY() - j1, blockposition2.getZ() - k);
 
-                        if (iblockdata.q()) {
+                        if (iblockdata.q()&& (!purpurConfig.blockTickEvent || new net.pl3x.purpur.event.block.BlockTickEvent(getWorld(), blockposition2.x, blockposition2.y, blockposition2.z, true).callEvent())) { // Purpur
                             iblockdata.b((World) this, blockposition2, this.random);
                         }
 
                         Fluid fluid = chunksection.b(blockposition2.getX() - j, blockposition2.getY() - j1, blockposition2.getZ() - k);
 
-                        if (fluid.g()) {
+                        if (fluid.g() && (!purpurConfig.fluidTickEvent || new net.pl3x.purpur.event.block.FluidTickEvent(getWorld(), blockposition2.x, blockposition2.y, blockposition2.z, true).callEvent())) { // Purpur
                             fluid.b(this, blockposition2, this.random);
                         }
 
@@ -541,6 +541,7 @@ public class WorldServer extends World {
         Fluid fluid = this.getFluid(nextticklistentry.a);
 
         if (fluid.getType() == nextticklistentry.b()) {
+            if (purpurConfig.fluidTickEvent && !new net.pl3x.purpur.event.block.FluidTickEvent(getWorld(), nextticklistentry.a.x, nextticklistentry.a.y, nextticklistentry.a.z).callEvent()) return; // Purpur
             fluid.a((World) this, nextticklistentry.a);
         }
 
@@ -550,6 +551,7 @@ public class WorldServer extends World {
         IBlockData iblockdata = this.getType(nextticklistentry.a);
 
         if (iblockdata.getBlock() == nextticklistentry.b()) {
+            if (purpurConfig.blockTickEvent && !new net.pl3x.purpur.event.block.BlockTickEvent(getWorld(), nextticklistentry.a.x, nextticklistentry.a.y, nextticklistentry.a.z).callEvent()) return; // Purpur
             iblockdata.a((World) this, nextticklistentry.a, this.random);
         }
 
diff --git a/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java b/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java
index a649a4c35..92eeaca42 100644
--- a/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java
+++ b/src/main/java/net/pl3x/purpur/PurpurWorldConfig.java
@@ -106,4 +106,11 @@ public class PurpurWorldConfig {
     private void itemsCanBreakTurtleEggs() {
         itemsCanBreakTurtleEggs = getBoolean("items-can-break-turtle-eggs", itemsCanBreakTurtleEggs);
     }
+
+    public boolean blockTickEvent = true;
+    public boolean fluidTickEvent = true;
+    private void tickEvents() {
+        blockTickEvent = getBoolean("block-tick-events", blockTickEvent);
+        fluidTickEvent = getBoolean("fluid-tick-events", fluidTickEvent);
+    }
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
index e0d89cc53..43ca8bb2e 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftWorld.java
@@ -2159,6 +2159,24 @@ public class CraftWorld implements World {
     }
     // Paper end
 
+    // Purpur start
+    public boolean isBlockTickEventEnabled() {
+        return getHandle().purpurConfig.blockTickEvent;
+    }
+
+    public void setBlockTickEventEnabled(boolean enabled) {
+        getHandle().purpurConfig.blockTickEvent = enabled;
+    }
+
+    public boolean isFluidTickEventEnabled() {
+        return getHandle().purpurConfig.fluidTickEvent;
+    }
+
+    public void setFluidTickEventEnabled(boolean enabled) {
+        getHandle().purpurConfig.fluidTickEvent = enabled;
+    }
+    // Purpur end
+
     // Spigot start
     private final Spigot spigot = new Spigot()
     {
-- 
2.20.1

